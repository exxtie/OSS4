#!/bin/bash
#Формат журнала:
#[Дата:Время Зона] Код IP "Сервер" "Тип Протокол" Получено Передано Длительность "Браузер" "Сжатие"
#
#Пример:
#[07/Apr/2022:17:01:50 +0300] 200 89.19.174.104 "www.cbias.ru" "GET HTTP/1.1" 135 374 0.028 "GuzzleHttp/7" "-"
#[07/Apr/2022:17:01:51 +0300] 301 192.168.211.242 "www.cbias.ru" "POST HTTP/1.1" 176 169 0.000 "-" "-"
#[07/Apr/2022:17:01:51 +0300] 200 77.232.165.35 "gzgu.cbias.ru" "POST HTTP/2.0" 1796 5330 0.081 "Mozilla/5.0 (Wi                                                                                                    ndows NT 10.0) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.4844.84 Safari/537.36" "-"
#
#Здесь:
#Дата         - дата запроса, в формате число/месяц/год, месяц - сокращение на английском
#Время        - время в формате час:минуты:секунды
#Зона         - временная зона, смещение относительно универсального времени UTC
#Код          - код ответа протокола HTTP
#IP           - адрес браузера
#Сервер       - имя веб-сервера
#Тип          - тип запроса HTTP
#Протокол     - использованный в запросе протокол HTTP и его версия
#Получено     - размер запроса, в байтах
#Передано     - размер переданного ответа, в байтах
#Длительность - время выполнения запроса
#Браузер      - идентификатор браузера - строка, переданная браузером серверу
#Сжатие       - коэффициент сжатия данных, если клиент запросил получение сжатого ответа
#
#
#Для запросов, выполненных со статусом '200',
#посчитать:
# - число запросов и
# - объём полученных веб-сервером данных,
#а также вывести все уникальные значения идентификатора браузера (поле "Браузер").

echo Content-type: text/html
echo ""

LOG_FILE=/var/www/stat/web.log

REQUESTS=`awk '{if ($3==200) {print $0}}' $LOG_FILE`
BROWSERS=`echo "$REQUESTS" | sed -r 's/^.+\.[0-9]* (".*") .+/\1/' | sort -u`

cat <<END
<html>
<head>
<title>Current statistic</title>
<meta http-equiv="Refresh" content="60">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta http-equiv="Cache-Control" content="no-cache">
</head>
<body>
<h2>Выборка из журнала веб-сервера</h2>
<br/>
<pre>
$BROWSERS
`awk '{if ($3==200) {N++; SIZE+=$8;}} END{print "Всего запросов "N", получено "SIZE" байт";}' $LOG_FILE`
</pre>
</body>
</html>
END
#------------------------------------------------------------
